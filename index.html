<html>
    <head>
    </head>
    <body style="text-align:center;">
        <canvas id="c"></canvas>
    </body>
    <script>
        var c = document.getElementById("c");
        c.width=512;
        c.height=512;
        var ctx = c.getContext("2d");
        ctx.imageSmoothingEnabled = false;
        var img = new Image();
        img.src = "js13k17.png";

        var tilesize = 8;
        var tiles = 32;
        var nRooms = 10; //Add different levels?
        var gamestate = 1;

        var charaX, charaY;
        var vx=0, vy=0;
        var frame=0;
        var turn = 0;
        var dir = "down";
        var i = 0;

        var map;
        function newMap(){
            map = [];
            for(var i=0; i < tiles; i++){
                var dir;
                if(Math.random() > 0.5){
                    dir = Math.random()>0.5? "up" : "down";
                }else{
                    dir = Math.random()>0.5? "left" : "right";
                }
                map.push(dir);
            }
            console.log(JSON.stringify(map));
        }

        var rooms = [];
        for (var n=0; n<nRooms;n++){
            rooms[n]=[]
            for (var i=0; i < tiles; i++){
                rooms[n][i]=newRoom();
            }
        }
        function newRoom(){
            charaX = tiles/2-1;
            charaY = tiles/2-1;
            for (var i=0; i < tiles; i++){
                room[i]=[];
            }
            for (var i=0; i < tiles; i++){
                for (var j=0; j < tiles; j++){
                    if(Math.random()>0.9){
                        var n = Math.floor(Math.random()*8)
                    }else{
                        var n = Math.floor(Math.random()*4);
                    }
                    room[i].push(n);
                }
            }
        }

        function gameLoop(){
            ctx.clearRect(0,0, 512,512);
            //Paint map
            for(var i=0; i < tiles * tilesize*2; i+=tilesize*2){
                for(var j=0; j < tiles * tilesize*2; j+=tilesize*2){
                    ctx.drawImage(img, tilesize*room[i/(tilesize*2)][j/(tilesize*2)], 16, tilesize, tilesize, j, i, tilesize*2, tilesize*2);
                }
            }
            //Move and paint chara
            if(turn==0){
                moveChara();
                frame=(frame+1)%2;
            }
            switch(dir){
                    case "down":
                    ctx.drawImage(img, 0, 0, 16, 16, charaX*tilesize*2-8, charaY*tilesize*2-8, 16*2, 16*2);
                    break;
                    case "up":
                    ctx.drawImage(img, 16, 0, 16, 16, charaX*tilesize*2-8, charaY*tilesize*2-8, 16*2, 16*2);
                    break;
                    case "left":
                    ctx.drawImage(img, 48, 0, 16, 16, charaX*tilesize*2-8, charaY*tilesize*2-8, 16*2, 16*2);
                    break;
                    case "right":
                    ctx.drawImage(img, 32, 0, 16, 16, charaX*tilesize*2-8, charaY*tilesize*2-8, 16*2, 16*2);
                    break;
                }
            turn=(turn+1)%20;
            setInterval(gameLoop, 100);
        }

        window.addEventListener("keydown", function (e) {
            switch (gamestate) {
                case 0:
                    init();
                    break;
                case 2:
                case 3:
                    gamestate = 0;
                    break;
                case 1:
                    if(e.keyCode == 37){
                        vx=-1;
                        dir="left";
                    }else if(e.keyCode == 39){
                        vx=1;
                        dir="right";
                    }else if(e.keyCode == 38){
                        vy=-1;
                        dir="up";
                    }else if(e.keyCode == 40){
                        vy=1;
                        dir="down";
                    }
                    if (e.keyCode == 65) { //A
                        glitch(0);
                    }else if(e.keyCode == 68){ //D
                        glitch(1);
                    }
                    break;
            }
        });

        window.addEventListener("keyup", function (e) {
            switch (gamestate) {
                case 0:
                    init();
                    break;
                case 2:
                case 3:
                    gamestate = 0;
                    break;
                case 1:
                    if(e.keyCode == 37){
                        vx=0;
                    }else if(e.keyCode == 39){
                        vx=0;
                    }else if(e.keyCode == 38){
                        vy=0;
                    }else if(e.keyCode == 40){
                        vy=0;
                    }
                    if (e.keyCode == 65) { //A
                        glitch(0);
                    }else if(e.keyCode == 68){ //D
                        glitch(1);
                    }
                    break;
            }
        });

        function moveChara(){
            charaX+=vx;
            charaY+=vy;
            correct=map[i];
            if(charaX<0){
                console.log(correct +"== left")
                if (correct=="left"){
                    newRoom();
                    charaX=tiles-3;
                    charaY=tiles/2-1;
                    dir="left";
                    i++;
                    console.log("correct")
                }else{
                    i=0;
                }
            }
            if(charaX>tiles-1){
                if (correct=="right"){
                    newRoom();
                    charaX=3;
                    charaY=tiles/2-1;
                    dir="right";
                    i++;
                    console.log("correct")
                }
            }
            if(charaY<0){
                if (correct=="up"){
                    newRoom();
                    charaX=tiles/2-1;
                    charaY=tiles-3;
                    dir="up";
                    i++;
                    console.log("correct")
                }
            }
            if(charaY>tiles-1){
                if (correct=="down"){
                    newRoom();
                    charaX=tiles/2-1;
                    charaY=3;
                    dir="down";
                    i++;
                    console.log("correct")
                }
            }
        }

        newMap();
        newRoom();
        gameLoop();
    </script>
</html>