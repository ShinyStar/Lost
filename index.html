<html>
    <head>
    </head>
    <body style="text-align:center;">
        <canvas id="c"></canvas>
    </body>
    <script>
        var c = document.getElementById("c");
        c.width=400;
        c.height=400;
        var ctx = c.getContext("2d");
        ctx.imageSmoothingEnabled = false;
        var img = new Image();
        img.src = "js13k17.png";

        var tilesize = 8;
        var tiles = 32;
        var gamestate = 1;

        var charaX, charaY;
        var vx=0, vy=0;
        var frame=0;
        var turn = 0;
        var dir = "down";

        var map;
        function newMap(){
            map = [];
            for(var i=0; i < tiles; i++){
                var dir;
                if(Math.random() > 0.5){
                    dir = Math.random()>0.5? "up" : "down";
                }else{
                    dir = Math.random()>0.5? "left" : "right";
                }
                map.push(dir);
            }
        }

        var room = [];
        for (var i=0; i < tiles; i++){
            room[i]=[];
        }
        function newRoom(){
            charaX = tiles/2-1;
            charaY = tiles/2-1;
            for (var i=0; i < tiles; i++){
                room[i]=[];
            }
            for (var i=0; i < tiles; i++){
                for (var j=0; j < tiles; j++){
                    if(Math.random()>0.9){
                        var n = Math.floor(Math.random()*8)
                    }else{
                        var n = Math.floor(Math.random()*4);
                    }
                    room[i].push(n);
                }
            }
        }

        function gameLoop(){
            ctx.clearRect(0,0, 400,400);
            //Paint map
            for(var i=0; i < tiles * tilesize*2; i+=tilesize*2){
                for(var j=0; j < tiles * tilesize*2; j+=tilesize*2){
                    ctx.drawImage(img, tilesize*room[i/(tilesize*2)][j/(tilesize*2)], 16, tilesize, tilesize, j, i, tilesize*2, tilesize*2);
                    //ctx.drawImage(img, 64, 0, tilesize, tilesize, j, i, tilesize*2, tilesize*2);
                }
            }
            //Move and paint chara
            if(turn==0){
                moveChara();
                frame=(frame+1)%2;
            }
            // if(vx==0 && vy==0){
            //     switch(dir){
            //         case "down":
            //         ctx.drawImage(img, 0, 0, 16, 16, charaX*tilesize, charaY*tilesize, 16*2, 16*2);
            //         break;
            //         case "up":
            //         ctx.drawImage(img, 16, 0, 16, 16, charaX*tilesize, charaY*tilesize, 16*2, 16*2);
            //         break;
            //         case "left":
            //         ctx.drawImage(img, 48, 0, 16, 16, charaX*tilesize, charaY*tilesize, 16*2, 16*2);
            //         break;
            //         case "right":
            //         ctx.drawImage(img, 32, 0, 16, 16, charaX*tilesize, charaY*tilesize, 16*2, 16*2);
            //         break;
            //     }
            // }else{
            //     switch(dir){
            //         case "down":
            //         ctx.drawImage(img, 0, frame*16, 16, 16, charaX*tilesize, charaY*tilesize, 16*2, 16*2);
            //         break;
            //         case "up":
            //         ctx.drawImage(img, 16, frame*16, 16, 16, charaX*tilesize, charaY*tilesize, 16*2, 16*2);
            //         break;
            //         case "left":
            //         ctx.drawImage(img, 48, frame*16, 16, 16, charaX*tilesize, charaY*tilesize, 16*2, 16*2);
            //         break;
            //         case "right":
            //         ctx.drawImage(img, 32, frame*16, 16, 16, charaX*tilesize, charaY*tilesize, 16*2, 16*2);
            //         break;
            //     }
            // }
            switch(dir){
                    case "down":
                    ctx.drawImage(img, 0, 0, 16, 16, charaX*tilesize, charaY*tilesize, 16*2, 16*2);
                    break;
                    case "up":
                    ctx.drawImage(img, 16, 0, 16, 16, charaX*tilesize, charaY*tilesize, 16*2, 16*2);
                    break;
                    case "left":
                    ctx.drawImage(img, 48, 0, 16, 16, charaX*tilesize, charaY*tilesize, 16*2, 16*2);
                    break;
                    case "right":
                    ctx.drawImage(img, 32, 0, 16, 16, charaX*tilesize, charaY*tilesize, 16*2, 16*2);
                    break;
                }
            turn=(turn+1)%20;
            setInterval(gameLoop, 100);
        }

        window.addEventListener("keydown", function (e) {
            switch (gamestate) {
                case 0:
                    init();
                    break;
                case 2:
                case 3:
                    gamestate = 0;
                    break;
                case 1:
                    if(e.keyCode == 37){
                        vx=-1;
                        dir="left";
                    }else if(e.keyCode == 39){
                        vx=1;
                        dir="right";
                    }else if(e.keyCode == 38){
                        vy=-1;
                        dir="up";
                    }else if(e.keyCode == 40){
                        vy=1;
                        dir="down";
                    }
                    if (e.keyCode == 65) { //A
                        glitch(0);
                    }else if(e.keyCode == 68){ //D
                        glitch(1);
                    }
                    break;
            }
        });

        window.addEventListener("keyup", function (e) {
            switch (gamestate) {
                case 0:
                    init();
                    break;
                case 2:
                case 3:
                    gamestate = 0;
                    break;
                case 1:
                    if(e.keyCode == 37){
                        vx=0;
                    }else if(e.keyCode == 39){
                        vx=0;
                    }else if(e.keyCode == 38){
                        vy=0;
                    }else if(e.keyCode == 40){
                        vy=0;
                    }
                    if (e.keyCode == 65) { //A
                        glitch(0);
                    }else if(e.keyCode == 68){ //D
                        glitch(1);
                    }
                    break;
            }
        });

        function moveChara(){
            charaX+=vx;
            charaY+=vy;
            if(charaX<0){charaX=0;}
            if(charaX>tiles){charaX=tiles;}
            if(charaY<0){charaY=0;}
            if(charaY>tiles){charaY=tiles;}
        }

        newRoom();
        gameLoop();
    </script>
</html>