<html>
    <head>
    </head>
    <body style="text-align:center;">
        <canvas id="c"></canvas>
    </body>
    <script>
        var c = document.getElementById("c");
        c.width=512;
        c.height=512;
        var ctx = c.getContext("2d");
        ctx.imageSmoothingEnabled = false;
        var clover = new Image();
        clover.src = "clover.png";
        var tilesImg = new Image();
        tilesImg.src = "tiles.png";
        //Every image will be scaled to twice its size so its more visible :)

        var currentR = 11;
        var inc = 0.1;

        var currentGlow = 11;
        var incg = 0.01;

        var tilesize = 8;
        var tiles = 32;
        var nRooms = 20; //Change difficulty?
        var gamestate = 0;

        var charaX=tiles/2-1, charaY=tiles/2-1;
        var darkX=-charaX, darkY=-charaY;
        var vx=0, vy=0;
        var frame=0;
        var turn = 0;
        var dir = "down";
        var currentRoom = 0;

        var upWords = ["north", "up", "forward", "arctic", "prow", "upwards"];
        var downWords = ["south", "down", "back", "austral", "stern", "downwards"];
        var rightWords = ["east", "right", "starboard", "orient", "sunrise", "righty"];
        var leftWords = ["west", "left", "port", "occident", "sunset", "leftie"];

        var alphabet = [{"letter":"a", "img": 0},
            {"letter":"b", "img": 0},
            {"letter":"c", "img": 0},
            {"letter":"d", "img": 0},
            {"letter":"e", "img": 0},
            {"letter":"f", "img": 0},
            {"letter":"g", "img": 0},
            {"letter":"h", "img": 0},
            {"letter":"i", "img": 0},
            {"letter":"j", "img": 0},
            {"letter":"k", "img": 0},
            {"letter":"l", "img": 0},
            {"letter":"m", "img": 0},
            {"letter":"n", "img": 0},
            {"letter":"o", "img": 0},
            {"letter":"p", "img": 0},
            {"letter":"q", "img": 0},
            {"letter":"r", "img": 0},
            {"letter":"s", "img": 0},
            {"letter":"t", "img": 0},
            {"letter":"u", "img": 0},
            {"letter":"v", "img": 0},
            {"letter":"w", "img": 0},
            {"letter":"x", "img": 0},
            {"letter":"y", "img": 0},
            {"letter":"z", "img": 0}]

        function assignAlphabet(){
            //I'm gonna shuffle an array of numbers to assign to each letter with the Fisher-Yates algorithm
            var numbers = [];
            for (var i=1; i<=26; i++){ //Not 0 cause it will be a special tile
                numbers.push(i);
            }

            var i1=numbers.length;
            var aux, i2;
            while(i1){
                i2=Math.floor(Math.random()*i1--);
                aux = numbers[i1];
                numbers[i1] = numbers[i2];
                numbers[i2] = aux;
            }

            var n=0;
            alphabet.forEach(function(x){
                x.img=numbers[n];
                n++;
            });
        }

        //Create the sequence of directions
        var map;
        function newMap(){
            map = [];
            for(var i=0; i < nRooms; i++){
                var dir;
                if(Math.random() > 0.5){
                    dir = Math.random()>0.5? "up" : "down";
                }else{
                    dir = Math.random()>0.5? "left" : "right";
                }
                map.push(dir);
            }
            //console.log(JSON.stringify(map));
        }

        var rooms = [];
        function generateRooms(){
            for (var n=0; n<nRooms; n++){
                rooms.push(newRoom(n));
            }
        }
        
        function newRoom(nRoom){
            var room=[];
            for (var i=0; i < tiles; i++){
                room[i]=[];
            }

            for (var i=0; i < tiles; i++){
                for (var j=0; j < tiles; j++){
                    if(Math.random()>0.9){
                        var n = 27 + Math.floor(Math.random()*8) //The last ones are less probable
                    }else{
                        var n = 27 + Math.floor(Math.random()*4);
                    }
                    room[i].push(n);
                }
            }

            if(nRoom==0){
                room[tiles/2-1][tiles/2-2]=0;
                room[tiles/2-1][tiles/2-1]=0;
                room[tiles/2-1][tiles/2]=0;
                room[tiles/2][tiles/2-2]=0;
                room[tiles/2][tiles/2]=0;
                room[tiles/2][tiles/2-1]=0;
                room[tiles/2+1][tiles/2-2]=0;
                room[tiles/2+1][tiles/2]=0;
                room[tiles/2+1][tiles/2-1]=0;
            }

            switch(map[nRoom]){
                case "up":
                    var word = upWords[Math.floor(Math.random()*(upWords.length-1))];
                    break;
                case "down":
                    var word = downWords[Math.floor(Math.random()*(downWords.length-1))];
                    break;
                case "left":
                    var word = leftWords[Math.floor(Math.random()*(leftWords.length-1))];
                    break;
                case "right":
                    var word = rightWords[Math.floor(Math.random()*(rightWords.length-1))];
                    break;
            }

            for(var l=0; l<word.length;l++){
                room[tiles/2+4][l+tiles/2-4]=alphabet[word.charCodeAt(l)-97].img;
            }

            return room;
        }

        function gameLoop(){
            switch(gamestate){
                case 0:
                    ctx.fillStyle="black";
                    ctx.fillRect(0,0,512,512);
                    ctx.shadowBlur = currentGlow;
                    ctx.shadowColor = "white";
                    ctx.font = "bold 50px Tahoma";
                    ctx.textAlign = "center";
                    ctx.fillStyle="white";
                    ctx.fillText("LOST", 256, 150);

                    ctx.font = "bold 15px Tahoma";
                    ctx.fillText("Move up, down, left or right with arrow keys.", 256, 256+30);
                    ctx.fillText("Advance to different rooms by walking towards the sides.", 256, 256+60);
                    ctx.fillText("If you go the wrong way, you'll find yourself at the start.", 256, 256+90);
                    ctx.fillText("Reach the end.", 256, 256+120);
                    ctx.fillText("Press any key to start.", 256, 256+180);

                    if(currentGlow>=50 || currentGlow<=2){
                        incg=-incg;
                    }
                    currentGlow+=incg;
                    ctx.shadowBlur = 0;
                break;
                case 1: //Playing
                    ctx.clearRect(0,0, 512,512);
                    //Paint map
                    for(var i=0; i < tiles * tilesize*2; i+=tilesize*2){
                        for(var j=0; j < tiles * tilesize*2; j+=tilesize*2){
                            ctx.drawImage(tilesImg, tilesize*rooms[currentRoom][i/(tilesize*2)][j/(tilesize*2)], 0, tilesize, tilesize, j, i, tilesize*2, tilesize*2);
                        }
                    }
                    //Move and paint chara
                    if(turn==0){
                        moveChara();
                        frame=(frame+1)%2;
                    }
                    switch(dir){
                            case "down":
                            ctx.drawImage(clover, 0, 0, 16, 16, charaX*tilesize*2-8, charaY*tilesize*2-8, 16*2, 16*2);
                            break;
                            case "up":
                            ctx.drawImage(clover, 16, 0, 16, 16, charaX*tilesize*2-8, charaY*tilesize*2-8, 16*2, 16*2);
                            break;
                            case "left":
                            ctx.drawImage(clover, 48, 0, 16, 16, charaX*tilesize*2-8, charaY*tilesize*2-8, 16*2, 16*2);
                            break;
                            case "right":
                            ctx.drawImage(clover, 32, 0, 16, 16, charaX*tilesize*2-8, charaY*tilesize*2-8, 16*2, 16*2);
                            break;
                        }
                    turn=(turn+1)%20;

                    //Paint darkness
                    if(currentR>=50 || currentR<=2){
                        inc=-inc;
                    }
                    currentR+=inc;
                    var darkness=ctx.createRadialGradient(charaX*tilesize*2,charaY*tilesize*2,currentR,charaX*tilesize*2,charaY*tilesize*2, 100);
                    darkness.addColorStop(0,"rgba(0,0,0,0)");
                    darkness.addColorStop(1,"black");
                    ctx.fillStyle=darkness;
                    ctx.fillRect(0,0, 512, 512);

                break;
                case 2:
                ctx.fillStyle="black";
                    ctx.fillRect(0,0,512,512);
                    ctx.shadowBlur = currentGlow;
                    ctx.shadowColor = "yellow";
                    ctx.font = "bold 20px Tahoma";
                    ctx.textAlign = "center";
                    ctx.fillStyle="white";
                    ctx.fillText("You reached the end! :D", 256, 150);

                    ctx.font = "bold 15px Tahoma";
                    ctx.fillText("Press Enter to repeat.", 256, 256+120);

                    if(currentGlow>=50 || currentGlow<=2){
                        incg=-incg;
                    }
                    currentGlow+=incg;
                    ctx.shadowBlur = 0;
                break;
            }
            setInterval(gameLoop, 100);
        }

        window.addEventListener("keydown", function (e) {
            switch (gamestate) {
                case 0:
                    gamestate = 1;
                    break;
                case 1:
                    if(e.keyCode == 37){
                        vx=-1;
                        dir="left";
                    }else if(e.keyCode == 39){
                        vx=1;
                        dir="right";
                    }else if(e.keyCode == 38){
                        vy=-1;
                        dir="up";
                    }else if(e.keyCode == 40){
                        vy=1;
                        dir="down";
                    }
                    if (e.keyCode == 65) { //A
                        glitch(0);
                    }else if(e.keyCode == 68){ //D
                        glitch(1);
                    }
                    break;
                    case 2:
                        if(e.keyCode == 13){
                            assignAlphabet();
                            newMap();
                            generateRooms();
                            gameLoop();
                            currentRoom=0;
                            charaX=tiles/2-1;
                            charaY=tiles/2-1;
                            dir = "down";
                            vx=0; vy=0;
                            gamestate = 1;
                        }
                    break;
            }
        });

        window.addEventListener("keyup", function (e) {
            switch (gamestate) {
                case 1:
                    if(e.keyCode == 37){
                        vx=0;
                    }else if(e.keyCode == 39){
                        vx=0;
                    }else if(e.keyCode == 38){
                        vy=0;
                    }else if(e.keyCode == 40){
                        vy=0;
                    }
                    if (e.keyCode == 65) { //A
                        glitch(0);
                    }else if(e.keyCode == 68){ //D
                        glitch(1);
                    }
                    break;
            }
        });

        function moveChara(){
            charaX+=vx;
            charaY+=vy;
            correct=map[currentRoom];
            if(charaX<0){
                if (correct=="left"){
                    charaX=tiles-3;
                    charaY=tiles/2-1;
                    dir="left";
                    currentRoom++;
                }else{
                    charaX=tiles/2-1;
                    charaY=tiles/2-1;
                    currentRoom=0;
                }
            }
            if(charaX>tiles-1){
                if (correct=="right"){
                    charaX=3;
                    charaY=tiles/2-1;
                    dir="right";
                    currentRoom++;
                }else{
                    charaX=tiles/2-1;
                    charaY=tiles/2-1;
                    currentRoom=0;
                }
            }
            if(charaY<0){
                if (correct=="up"){
                    charaX=tiles/2-1;
                    charaY=tiles-3;
                    dir="up";
                    currentRoom++;
                }else{
                    charaX=tiles/2-1;
                    charaY=tiles/2-1;
                    currentRoom=0;
                }
            }
            if(charaY>tiles-1){
                if (correct=="down"){
                    charaX=tiles/2-1;
                    charaY=3;
                    dir="down";
                    currentRoom++;
                }else{
                    charaX=tiles/2-1;
                    charaY=tiles/2-1;
                    currentRoom=0;
                }
            }
            darkX=charaX-tiles;
            darkY=charaY-tiles;
            if(currentRoom==nRooms){
                gamestate=2;
            }
        }

        assignAlphabet();
        newMap();
        generateRooms();
        gameLoop();
    </script>
</html>